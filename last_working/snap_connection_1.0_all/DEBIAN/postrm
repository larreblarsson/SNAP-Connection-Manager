#!/bin/sh
set -e

# Define the relative path within the user's home directory
APP_DATA_RELATIVE_PATH=".local/share/snap_connection_manager"

# Attempt to determine the home directory of the user who initiated the 'sudo' command.
# $SUDO_USER is set by 'sudo' and contains the original user's name.
# getent passwd is a reliable way to look up user information, including home directory.
USER_HOME_DIR=""
if [ -n "$SUDO_USER" ]; then
    USER_HOME_DIR=$(getent passwd "$SUDO_USER" | cut -d: -f6)
fi

# Fallback: If SUDO_USER is not set (e.g., running directly as root or with 'su -'),
# and HOME is not /root, use the current HOME environment variable.
# This might catch cases where apt is run by a user who became root via 'su'.
if [ -z "$USER_HOME_DIR" ] && [ -n "$HOME" ] && [ "$HOME" != "/root" ]; then
    USER_HOME_DIR="$HOME"
fi

# If no user home could be reliably determined, we'll indicate this
# or default to /root if it's considered safe for *system-wide* cleanup.
# For this app, which stores user data, we want to be cautious.
# If USER_HOME_DIR is still empty, the cleanup logic will be skipped.

# Construct the full path to the application's data directory
# Only proceed if USER_HOME_DIR was successfully determined
APP_DATA_DIR=""
if [ -n "$USER_HOME_DIR" ]; then
    APP_DATA_DIR="${USER_HOME_DIR}/${APP_DATA_RELATIVE_PATH}"
fi

# Safety check: Ensure the target directory is indeed within a typical user home path
# (or root's home if running as root) before attempting to remove.
IS_SAFE_PATH=false
if [ -n "$APP_DATA_DIR" ]; then
    if echo "$APP_DATA_DIR" | grep -q "^/home/"; then
        IS_SAFE_PATH=true
    elif [ "$USER_HOME_DIR" = "/root" ] && echo "$APP_DATA_DIR" | grep -q "^/root/"; then
        # This clause handles cases where root might have created data,
        # though your app's design points to non-root user data.
        IS_SAFE_PATH=true
    fi
fi


case "$1" in
    purge)
        if $IS_SAFE_PATH && [ -d "$APP_DATA_DIR" ]; then
            echo "Purging SNAP Connection Manager user data from: $APP_DATA_DIR"
            rm -rf "$APP_DATA_DIR"
            echo "User data directory removed."
        else
            echo "Skipping purge of SNAP Connection Manager user data. Directory '$APP_DATA_DIR' does not exist or is not a recognized safe user home path."
            # Note: This message will be visible during purge.
        fi
        ;;
    remove|upgrade|deconfigure|abort-install|abort-upgrade|disappear)
        # For 'remove' and other actions, we typically do nothing to user data.
        # This ensures the user's data persists if they're just temporarily removing the package.
        ;;
    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

exit 0
