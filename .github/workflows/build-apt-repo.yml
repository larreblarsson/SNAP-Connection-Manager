name: Build and Publish APT Repository

on:
  push:
    branches: [ main ]
    paths:
      - '*.deb'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GNUPGHOME: ${{ runner.temp }}/gnupg
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev gnupg apt-utils gzip apt-transport-https
        shell: bash

      - name: Detect .deb and package metadata
        id: detect
        run: |
          set -e
          # pick the most recent .deb in the repo root
          DEB_FILE=$(ls -1t *.deb 2>/dev/null | head -n1 || true)
          if [ -z "$DEB_FILE" ]; then
            echo "No .deb found in repository root. Exiting."
            exit 0
          fi
          PKG_NAME=$(dpkg-deb -f "$DEB_FILE" Package)
          PKG_VERSION=$(dpkg-deb -f "$DEB_FILE" Version)
          PKG_ARCH=$(dpkg-deb -f "$DEB_FILE" Architecture)
          echo "Detected: $DEB_FILE -> $PKG_NAME $PKG_VERSION $PKG_ARCH"
          echo "DEB_FILE=$DEB_FILE" >> $GITHUB_ENV
          echo "PKG_NAME=$PKG_NAME" >> $GITHUB_ENV
          echo "PKG_VERSION=$PKG_VERSION" >> $GITHUB_ENV
          echo "PKG_ARCH=$PKG_ARCH" >> $GITHUB_ENV
        shell: bash

      - name: Import GPG Private Key and export public key
        run: |
          set -e
          mkdir -p "$GNUPGHOME"
          chmod 700 "$GNUPGHOME"
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import --yes
          KEY_FPR=$(gpg --list-keys --with-colons | awk -F: '/^fpr:/ {print $10; exit}')
          mkdir -p repo
          gpg --armor --export "$KEY_FPR" > repo/public.key
          echo "Exported public key to repo/public.key (fingerprint: $KEY_FPR)"
        shell: bash

      - name: Build APT repository structure, index and sign
        env:
          DEB_FILE: ${{ env.DEB_FILE }}
          PKG_NAME: ${{ env.PKG_NAME }}
          PKG_VERSION: ${{ env.PKG_VERSION }}
          PKG_ARCH: ${{ env.PKG_ARCH }}
        run: |
          set -e
          # Prepare directories
          POOLDIR="repo/pool/main/${PKG_NAME}"
          DISTDIR_AMD64="repo/dists/stable/main/binary-amd64"
          DISTDIR_ARCH="repo/dists/stable/main/binary-${PKG_ARCH}"
          mkdir -p "$POOLDIR" "$DISTDIR_AMD64" "$DISTDIR_ARCH"

          # Copy the detected .deb into pool
          echo "Copying $DEB_FILE -> $POOLDIR/"
          cp -v "$DEB_FILE" "$POOLDIR/"

          # Generate Packages.gz from the pool directory (ensures Filename: pool/...)
          dpkg-scanpackages repo/pool /dev/null | gzip -9c > "$DISTDIR_ARCH/Packages.gz"
          # Also generate amd64 index for clients that request binary-amd64 (if arch is amd64 this duplicates)
          dpkg-scanpackages repo/pool /dev/null | gzip -9c > "$DISTDIR_AMD64/Packages.gz"

          # Create apt-ftparchive config and generate Release metadata
          cat > apt-ftparchive.conf <<'EOF'
          APT::FTPArchive::Release::Suite "stable";
          APT::FTPArchive::Release::Codename "stable";
          APT::FTPArchive::Release::Components "main";
          APT::FTPArchive::Release::Architectures "${PKG_ARCH} amd64 all";
          EOF
          # Replace placeholder with actual arch
          sed -i "s/\${PKG_ARCH}/${PKG_ARCH}/g" apt-ftparchive.conf
          apt-ftparchive -c apt-ftparchive.conf release repo/dists/stable > repo/dists/stable/Release

          # Sign the Release file (create InRelease and Release.gpg)
          GPG_OPTS="--batch --yes --pinentry-mode loopback --passphrase '${{ secrets.GPG_PASSPHRASE }}'"
          gpg $GPG_OPTS --clearsign -o repo/dists/stable/InRelease repo/dists/stable/Release
          gpg $GPG_OPTS -abs -o repo/dists/stable/Release.gpg repo/dists/stable/Release

          # Append a simple changelog entry into the pages repo (included in Pages)
          mkdir -p repo/releases
          echo "- ${PKG_NAME} ${PKG_VERSION} ($(date -u +"%Y-%m-%d %H:%M UTC")): published" >> repo/RELEASES.md
          echo "Added release note to repo/RELEASES.md"

          # Show a short listing for verification in the workflow log
          echo "Repo layout:"
          find repo -maxdepth 5 -type f -print
        shell: bash

      - name: Create GitHub Release and attach .deb
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: v${{ env.PKG_VERSION }}
          release_name: ${{ env.PKG_NAME }} ${{ env.PKG_VERSION }}
          body: "Automated release for ${{ env.PKG_NAME }} ${{ env.PKG_VERSION }}"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload .deb to GitHub Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: repo/pool/main/${{ env.PKG_NAME }}/${{ env.DEB_FILE }}
          asset_name: ${{ env.DEB_FILE }}
          asset_content_type: application/vnd.debian.binary-package

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: repo/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

