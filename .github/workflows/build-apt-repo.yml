name: Build and Publish APT Repo

on:
  push:
    tags:
      - '*'   # Trigger only on tag pushes (e.g. 1.2.1 or v1.2.1)

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts build-essential debhelper \
            python3-all python3-gi gir1.2-gtk-3.0 gir1.2-vte-2.91 \
            gnupg apt-utils apt-ftparchive

      - name: Bump Debian changelog version
        run: |
          RAW_VERSION=${GITHUB_REF_NAME}
          VERSION=${RAW_VERSION#v}   # strip leading "v" if present
          echo "Using version: $VERSION"

          export DEBFULLNAME="Tomas Larsson"
          export DEBEMAIL="you@example.com"

          dch --newversion "${VERSION}-1" "Release ${VERSION}"
          head -n 5 debian/changelog

      - name: Build package
        run: |
          dpkg-buildpackage -us -uc

      - name: Import GPG key
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: Publish APT repo
        run: |
          REPO_DIR=repo
          CODENAME=stable
          PACKAGE_DEB=$(ls -t ../*.deb | head -n1)

          mkdir -p ${REPO_DIR}/pool
          mkdir -p ${REPO_DIR}/dists/${CODENAME}/main/binary-amd64
          mkdir -p ${REPO_DIR}/dists/${CODENAME}/main/binary-all

          cp ${PACKAGE_DEB} ${REPO_DIR}/pool/

          # Generate Packages for amd64
          apt-ftparchive packages ${REPO_DIR}/pool > ${REPO_DIR}/dists/${CODENAME}/main/binary-amd64/Packages
          gzip -c ${REPO_DIR}/dists/${CODENAME}/main/binary-amd64/Packages > ${REPO_DIR}/dists/${CODENAME}/main/binary-amd64/Packages.gz

          # Generate Packages for all
          apt-ftparchive packages ${REPO_DIR}/pool > ${REPO_DIR}/dists/${CODENAME}/main/binary-all/Packages
          gzip -c ${REPO_DIR}/dists/${CODENAME}/main/binary-all/Packages > ${REPO_DIR}/dists/${CODENAME}/main/binary-all/Packages.gz

          # Generate Release
          apt-ftparchive release ${REPO_DIR}/dists/${CODENAME} > ${REPO_DIR}/dists/${CODENAME}/Release

          # Sign Release
          gpg --batch --yes --clearsign -o ${REPO_DIR}/dists/${CODENAME}/InRelease ${REPO_DIR}/dists/${CODENAME}/Release
          gpg --batch --yes --armor --detach-sign -o ${REPO_DIR}/dists/${CODENAME}/Release.gpg ${REPO_DIR}/dists/${CODENAME}/Release

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: repo

