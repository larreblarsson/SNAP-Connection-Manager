name: Build and Publish APT Repository

on:
  push:
    branches: [ main ]
    paths:
      - '*.deb'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GNUPGHOME: ${{ runner.temp }}/gnupg

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev gnupg apt-utils gzip apt-ftparchive

      - name: Detect .deb and package metadata
        id: detect
        run: |
          set -euo pipefail
          DEB_FILE=$(ls -1t *.deb 2>/dev/null | head -n1 || true)
          if [ -z "$DEB_FILE" ]; then
            echo "No .deb found in repository root. Exiting."
            echo "found_deb=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          PKG_NAME=$(dpkg-deb -f "$DEB_FILE" Package)
          PKG_VERSION=$(dpkg-deb -f "$DEB_FILE" Version)
          PKG_ARCH=$(dpkg-deb -f "$DEB_FILE" Architecture)
          echo "Detected: $DEB_FILE -> $PKG_NAME $PKG_VERSION $PKG_ARCH"
          echo "DEB_FILE=$DEB_FILE" >> $GITHUB_ENV
          echo "PKG_NAME=$PKG_NAME" >> $GITHUB_ENV
          echo "PKG_VERSION=$PKG_VERSION" >> $GITHUB_ENV
          echo "PKG_ARCH=$PKG_ARCH" >> $GITHUB_ENV
          echo "found_deb=true" >> $GITHUB_OUTPUT
        shell: bash

      - name: Import GPG private key and export public key
        if: steps.detect.outputs.found_deb == 'true'
        run: |
          set -euo pipefail
          mkdir -p "$GNUPGHOME"
          chmod 700 "$GNUPGHOME"
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import --yes
          KEY_FPR=$(gpg --list-keys --with-colons | awk -F: '/^fpr:/ {print $10; exit}')
          mkdir -p repo
          gpg --armor --export "$KEY_FPR" > repo/public.key
          echo "Exported public key to repo/public.key (fingerprint: $KEY_FPR)"
        shell: bash

      - name: Build APT repository structure, index and sign
        if: steps.detect.outputs.found_deb == 'true'
        env:
          DEB_FILE: ${{ env.DEB_FILE }}
          PKG_NAME: ${{ env.PKG_NAME }}
          PKG_VERSION: ${{ env.PKG_VERSION }}
          PKG_ARCH: ${{ env.PKG_ARCH }}
        run: |
          set -euo pipefail

          POOLDIR="repo/pool/main/${PKG_NAME}"
          DISTDIR_ARCH="repo/dists/stable/main/binary-${PKG_ARCH}"
          DISTDIR_AMD64="repo/dists/stable/main/binary-amd64"

          mkdir -p "$POOLDIR" "$DISTDIR_ARCH" "$DISTDIR_AMD64"

          # Copy the detected .deb into pool
          cp -v "$DEB_FILE" "$POOLDIR/"

          # Generate Packages.gz from the pool directory (ensures Filename: pool/...)
          dpkg-scanpackages repo/pool /dev/null | gzip -9c > "$DISTDIR_ARCH/Packages.gz"
          dpkg-scanpackages repo/pool /dev/null | gzip -9c > "$DISTDIR_AMD64/Packages.gz"

          # Create a minimal Release file
          cat > repo/dists/stable/Release <<'EOF'
Origin: SNAP-Connection-Manager
Label: SNAP Connection Manager
Suite: stable
Codename: stable
Architectures: amd64 all
Components: main
Description: SNAP Connection Manager APT repository
EOF

          # Sign the Release file (create InRelease and Release.gpg)
          GPG_OPTS="--batch --yes --pinentry-mode loopback --passphrase '${{ secrets.GPG_PASSPHRASE }}'"
          gpg $GPG_OPTS --clearsign -o repo/dists/stable/InRelease repo/dists/stable/Release
          gpg $GPG_OPTS -abs -o repo/dists/stable/Release.gpg repo/dists/stable/Release

          # Add a short release note
          echo "- ${PKG_NAME} ${PKG_VERSION} ($(date -u +"%Y-%m-%d %H:%M UTC")): published" >> repo/RELEASES.md

          # Show a short listing for verification in the workflow log
          echo "Repo layout:"
          find repo -maxdepth 5 -type f -print
        shell: bash

      - name: Create GitHub Release
        if: steps.detect.outputs.found_deb == 'true'
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: v${{ env.PKG_VERSION }}
          release_name: ${{ env.PKG_NAME }} ${{ env.PKG_VERSION }}
          body: "Automated release for ${{ env.PKG_NAME }} ${{ env.PKG_VERSION }}"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload .deb to GitHub Release
        if: steps.detect.outputs.found_deb == 'true'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: repo/pool/main/${{ env.PKG_NAME }}/${{ env.DEB_FILE }}
          asset_name: ${{ env.DEB_FILE }}
          asset_content_type: application/vnd.debian.binary-package

      - name: Upload Pages Artifact
        if: steps.detect.outputs.found_deb == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: repo/

      - name: Deploy to GitHub Pages
        if: steps.detect.outputs.found_deb == 'true'
        id: deployment
        uses: actions/deploy-pages@v4

