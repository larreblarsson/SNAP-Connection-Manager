name: Build and Publish APT Repo

on:
  push:
    tags:
      - '*'   # Run only when a tag is pushed (e.g. 1.2.1 or v1.2.1)

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts build-essential debhelper \
            python3-all python3-gi gir1.2-gtk-3.0 gir1.2-vte-2.91 \
            gnupg apt-utils

      - name: Check apt-ftparchive
        run: which apt-ftparchive && apt-ftparchive --version

      - name: Bump Debian changelog version
        run: |
          RAW_VERSION=${GITHUB_REF_NAME}
          VERSION=${RAW_VERSION#v}   # strip leading "v" if present
          echo "Using version: $VERSION"

          export DEBFULLNAME="Tomas Larsson"
          export DEBEMAIL="you@example.com"

          dch --newversion "${VERSION}-1" "Release ${VERSION}"
          head -n 5 debian/changelog

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc

      - name: Import GPG key
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: Prepare APT repo
        run: |
          REPO_DIR=repo
          CODENAME=stable
          PACKAGE_DEB=$(ls -t ../snap-connection-manager*.deb | head -n1)

          # Clean old repo contents
          rm -rf ${REPO_DIR}
          mkdir -p ${REPO_DIR}/pool
          mkdir -p ${REPO_DIR}/dists/${CODENAME}/main/binary-amd64
          mkdir -p ${REPO_DIR}/dists/${CODENAME}/main/binary-all

          cp ${PACKAGE_DEB} ${REPO_DIR}/pool/

          cd ${REPO_DIR}

          # Generate Packages for amd64
          apt-ftparchive packages pool > dists/${CODENAME}/main/binary-amd64/Packages
          gzip -c dists/${CODENAME}/main/binary-amd64/Packages > dists/${CODENAME}/main/binary-amd64/Packages.gz

          # Generate Packages for all
          apt-ftparchive packages pool > dists/${CODENAME}/main/binary-all/Packages
          gzip -c dists/${CODENAME}/main/binary-all/Packages > dists/${CODENAME}/main/binary-all/Packages.gz

          # Generate Release with config
           apt-ftparchive -c ../.github/apt-release.conf release dists/${CODENAME} > dists/${CODENAME}/Release
 
          # Sign Release with loopback pinentry
          gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" \
            --clearsign -o dists/${CODENAME}/InRelease dists/${CODENAME}/Release
          gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" \
            --armor --detach-sign -o dists/${CODENAME}/Release.gpg dists/${CODENAME}/Release

          # Debug: show version in Packages
          grep Version dists/${CODENAME}/main/binary-amd64/Packages
          grep Version dists/${CODENAME}/main/binary-all/Packages
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: repo
          publish_branch: gh-pages
          force_orphan: true

      - name: Verify published Packages
        run: |
          curl -s https://larreblarsson.github.io/SNAP-Connection-Manager/dists/stable/main/binary-amd64/Packages | grep Version

      - name: Extract full changelog entry
        id: changelog
        run: |
          echo 'RELEASE_BODY<<EOF' >> $GITHUB_ENV
          dpkg-parsechangelog --count 1 >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV
          

      - name: Create GitHub Release and upload .deb
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: snap-connection-manager ${{ github.ref_name }}
          body: ${{ env.RELEASE_BODY }}
          files: ../snap-connection-manager*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

